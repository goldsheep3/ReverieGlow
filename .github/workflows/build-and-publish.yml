name: Build and Publish Minecraft Modpack (No Remote Commit)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´å†å²ä»¥è·å–æäº¤ä¿¡æ¯
    
    - name: Get commit message title
      id: commit
      run: |
        COMMIT_TITLE=$(git log -1 --pretty=format:'%s')
        echo "title=$COMMIT_TITLE" >> $GITHUB_OUTPUT
        echo "Commit title: $COMMIT_TITLE"
    
    - name: Install jq for JSON5 processing
      run: |
        # å®‰è£… jq ç”¨äº JSON å¤„ç†
        sudo apt-get update
        sudo apt-get install -y jq
        
        # å®‰è£… Node.js ç”¨äºå¤„ç† JSON5
        curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
        sudo apt-get install -y nodejs
        
        # å…¨å±€å®‰è£… json5 åŒ…ç”¨äºè½¬æ¢ JSON5 åˆ° JSON
        sudo npm install -g json5
    
    - name: Read configuration files
      id: config
      run: |
        # æ£€æŸ¥ pub.json5 æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if [ ! -f "pub.json5" ]; then
          echo "Error: pub.json5 not found"
          exit 1
        fi
        
        # å°† JSON5 è½¬æ¢ä¸º JSON å¹¶è¯»å–é…ç½®
        json5 pub.json5 > pub.json
        
        # è¯»å–é…ç½®é¡¹
        PUBRENAME_CONTENT=$(jq -r '.rename' pub.json)
        PUBVERFILENAME_CONTENT=$(jq -r '.currentVersion' pub.json)
        PUBRELEASENAME_CONTENT=$(jq -r '.releaseName' pub.json)
        
        # æ›¿æ¢æ¨¡æ¿ä¸­çš„å ä½ç¬¦
        NEW_VERSION_ID=$(echo "$PUBRENAME_CONTENT" | sed "s/{}/${{ steps.commit.outputs.title }}/g")
        RELEASE_NAME=$(echo "$PUBRELEASENAME_CONTENT" | sed "s/{}/${{ steps.commit.outputs.title }}/g")
        
        echo "current_version=$PUBVERFILENAME_CONTENT" >> $GITHUB_OUTPUT
        echo "new_version=$NEW_VERSION_ID" >> $GITHUB_OUTPUT
        echo "release_name=$RELEASE_NAME" >> $GITHUB_OUTPUT
        
        echo "Current version: $PUBVERFILENAME_CONTENT"
        echo "New version: $NEW_VERSION_ID"
        echo "Release name: $RELEASE_NAME"
        
        # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        rm pub.json
    
    - name: Package resourcepack
      run: |
        # æ£€æŸ¥ç›®æ ‡èµ„æºåŒ…æ–‡ä»¶å¤¹æ˜¯å¦å­˜åœ¨
        if [ -d "resourcepacks/Reglowæ±‰åŒ–è¡¥å……åŒ…" ]; then
          echo "Found Reglowæ±‰åŒ–è¡¥å……åŒ… folder, packaging..."
          cd resourcepacks
          zip -r "Reglowæ±‰åŒ–è¡¥å……åŒ….zip" "Reglowæ±‰åŒ–è¡¥å……åŒ…/"
          rm -rf "Reglowæ±‰åŒ–è¡¥å……åŒ…"
          cd ..
          echo "Packaged and removed original folder"
        else
          echo "Reglowæ±‰åŒ–è¡¥å……åŒ… folder not found, skipping packaging"
        fi
    
    - name: Update options.txt
      run: |
        # æ›´æ–° options.txt ä¸­çš„èµ„æºåŒ…å¼•ç”¨
        if [ -f "options.txt" ]; then
          sed -i 's/"file\/Reglowæ±‰åŒ–è¡¥å……åŒ…"/"file\/Reglowæ±‰åŒ–è¡¥å……åŒ….zip"/g' options.txt
          echo "Updated options.txt resourcePacks reference"
        else
          echo "options.txt not found"
        fi
    
    - name: Remove files based on pub.json5
      run: |
        # æ£€æŸ¥ pub.json5 æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if [ ! -f "pub.json5" ]; then
          echo "pub.json5 not found, skipping file removal"
          exit 0
        fi
        
        # å°† JSON5 è½¬æ¢ä¸º JSON å¹¶è¯»å–è¦åˆ é™¤çš„æ–‡ä»¶åˆ—è¡¨
        json5 pub.json5 > pub_temp.json
        
        # è¯»å–è¦åˆ é™¤çš„æ–‡ä»¶åˆ—è¡¨
        REMOVE_FILES=$(jq -r '.remove[]?' pub_temp.json)
        
        if [ -z "$REMOVE_FILES" ]; then
          echo "No files specified for removal"
        else
          echo "Files to remove:"
          echo "$REMOVE_FILES"
          echo ""
          
          # é€ä¸ªåˆ é™¤æ–‡ä»¶
          while IFS= read -r file; do
            if [ -n "$file" ] && [ "$file" != "null" ]; then
              if [ -e "$file" ]; then
                if [ -d "$file" ]; then
                  rm -rf "$file"
                  echo "Removed directory: $file"
                elif [ -f "$file" ]; then
                  rm -f "$file"
                  echo "Removed file: $file"
                fi
              else
                echo "File/directory not found: $file"
              fi
            fi
          done <<< "$REMOVE_FILES"
        fi
        
        # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        rm pub_temp.json
    
    - name: Rename version files
      run: |
        CURRENT_VERSION="${{ steps.config.outputs.current_version }}"
        NEW_VERSION="${{ steps.config.outputs.new_version }}"
        
        echo "Renaming from $CURRENT_VERSION to $NEW_VERSION"
        
        # é‡å‘½å .jar æ–‡ä»¶
        if [ -f "${CURRENT_VERSION}.jar" ]; then
          mv "${CURRENT_VERSION}.jar" "${NEW_VERSION}.jar"
          echo "Renamed ${CURRENT_VERSION}.jar to ${NEW_VERSION}.jar"
        else
          echo "${CURRENT_VERSION}.jar not found"
        fi
        
        # é‡å‘½å .json æ–‡ä»¶
        if [ -f "${CURRENT_VERSION}.json" ]; then
          mv "${CURRENT_VERSION}.json" "${NEW_VERSION}.json"
          echo "Renamed ${CURRENT_VERSION}.json to ${NEW_VERSION}.json"
        else
          echo "${CURRENT_VERSION}.json not found"
        fi
    
    - name: Update JSON file id field
      run: |
        CURRENT_VERSION="${{ steps.config.outputs.current_version }}"
        NEW_VERSION="${{ steps.config.outputs.new_version }}"
        JSON_FILE="${NEW_VERSION}.json"
        
        # æ›´æ–° JSON æ–‡ä»¶ä¸­çš„ id å­—æ®µ
        if [ -f "$JSON_FILE" ]; then
          # ä½¿ç”¨ sed æ›¿æ¢ JSON ä¸­çš„ id å­—æ®µ
          sed -i "s/\"id\": \"$CURRENT_VERSION\"/\"id\": \"$NEW_VERSION\"/g" "$JSON_FILE"
          echo "Updated id field in $JSON_FILE from $CURRENT_VERSION to $NEW_VERSION"
          
          # éªŒè¯æ›´æ”¹
          if grep -q "\"id\": \"$NEW_VERSION\"" "$JSON_FILE"; then
            echo "âœ“ Successfully updated id field"
          else
            echo "âš  Warning: id field may not have been updated correctly"
          fi
        else
          echo "JSON file $JSON_FILE not found"
        fi
    
    # æ³¨æ„ï¼šæ­¤ç‰ˆæœ¬ä¸ä¼šæäº¤æ›´æ”¹åˆ°è¿œç¨‹ä»“åº“
    # æ‰€æœ‰å¤„ç†éƒ½åªåœ¨æ„å»ºç¯å¢ƒä¸­è¿›è¡Œï¼Œä¸å½±å“æºä»£ç ä»“åº“
    
    - name: Create release artifacts
      run: |
        NEW_VERSION="${{ steps.config.outputs.new_version }}"
        
        # åˆ›å»ºæ„å»ºä¿¡æ¯æ–‡ä»¶
        echo "Build Information" > build-info.txt
        echo "=================" >> build-info.txt
        echo "Version: $NEW_VERSION" >> build-info.txt
        echo "Commit: ${{ github.sha }}" >> build-info.txt
        echo "Commit Message: ${{ steps.commit.outputs.title }}" >> build-info.txt
        echo "Build Date: $(date)" >> build-info.txt
        echo "Branch: ${{ github.ref_name }}" >> build-info.txt
        echo "Note: No changes committed to remote repository" >> build-info.txt
        echo "" >> build-info.txt
        echo "Package Contents:" >> build-info.txt
        echo "- Processed resourcepacks (Reglowæ±‰åŒ–è¡¥å……åŒ… converted to .zip)" >> build-info.txt
        echo "- Files removed as specified in pub.json5" >> build-info.txt
        echo "- Version files renamed and updated" >> build-info.txt
        echo "- Excludes: .github/, pub.json5" >> build-info.txt
        
        echo "Created build information file"
    
    - name: Create release package
      id: create_package
      run: |
        NEW_VERSION="${{ steps.config.outputs.new_version }}"
        RELEASE_NAME="${{ steps.config.outputs.release_name }}"
        PACKAGE_NAME="${RELEASE_NAME// /_}_$(date +%Y%m%d_%H%M%S).zip"
        
        echo "Creating release package: $PACKAGE_NAME"
        
        # åˆ›å»ºä¸€ä¸ªä¸´æ—¶ç›®å½•æ¥ç»„ç»‡æ–‡ä»¶
        mkdir -p release_temp
        
        # å¤åˆ¶ä¸»è¦æ–‡ä»¶åˆ°å‘å¸ƒç›®å½•
        if [ -f "${NEW_VERSION}.jar" ]; then
          cp "${NEW_VERSION}.jar" release_temp/
        fi
        
        if [ -f "${NEW_VERSION}.json" ]; then
          cp "${NEW_VERSION}.json" release_temp/
        fi
        
        # å¤åˆ¶é…ç½®æ–‡ä»¶
        if [ -f "options.txt" ]; then
          cp "options.txt" release_temp/
        fi
        
        # å¤åˆ¶èµ„æºåŒ…ç›®å½•
        if [ -d "resourcepacks" ] && [ "$(ls -A resourcepacks 2>/dev/null)" ]; then
          cp -r "resourcepacks" release_temp/
        fi
        
        # å¤åˆ¶æ¨¡ç»„ç›®å½• (å¦‚æœå­˜åœ¨ä¸”ä¸ä¸ºç©º)
        if [ -d "mods" ] && [ "$(ls -A mods 2>/dev/null)" ]; then
          cp -r "mods" release_temp/
        fi
        
        # å¤åˆ¶é…ç½®ç›®å½•
        if [ -d "config" ] && [ "$(ls -A config 2>/dev/null)" ]; then
          cp -r "config" release_temp/
        fi
        
        # å¤åˆ¶å…¶ä»–é‡è¦ç›®å½•
        for dir in "kubejs" "defaultconfigs" "local" "patchouli_books" "shaderpacks" "tacz" "tlm_custom_pack" "xaero"; do
          if [ -d "$dir" ] && [ "$(ls -A $dir 2>/dev/null)" ]; then
            cp -r "$dir" release_temp/
          fi
        done
        
        # å¤åˆ¶å…¶ä»–é‡è¦æ–‡ä»¶ï¼ˆæ’é™¤å·¥ä½œæµæ–‡ä»¶å’Œé…ç½®æ–‡ä»¶ï¼‰
        for file in "*.dll" "*.toml" "*.ini"; do
          if ls $file 1> /dev/null 2>&1; then
            cp $file release_temp/ 2>/dev/null || true
          fi
        done
        
        # å•ç‹¬å¤„ç† JSON å’Œ TXT æ–‡ä»¶ï¼Œæ’é™¤ç‰¹å®šæ–‡ä»¶
        for file in *.json; do
          if [ -f "$file" ] && [ "$file" != "pub.json5" ]; then
            cp "$file" release_temp/ 2>/dev/null || true
          fi
        done
        
        for file in *.txt; do
          if [ -f "$file" ]; then
            cp "$file" release_temp/ 2>/dev/null || true
          fi
        done
        
        # æ·»åŠ æ„å»ºä¿¡æ¯æ–‡ä»¶
        cp build-info.txt release_temp/
        
        # åˆ›å»ºå‘å¸ƒåŒ…ï¼Œæ’é™¤å·¥ä½œæµæ–‡ä»¶å’Œé…ç½®æ–‡ä»¶
        cd release_temp
        zip -r "../$PACKAGE_NAME" . \
          -x "*.git*" "*/.git/*" \
          -x ".github/*" \
          -x "pub.json5"
        cd ..
        
        # æ¸…ç†ä¸´æ—¶ç›®å½•
        rm -rf release_temp
        
        echo "package_name=$PACKAGE_NAME" >> $GITHUB_OUTPUT
        echo "Created release package: $PACKAGE_NAME"
        echo "Package size: $(du -h $PACKAGE_NAME | cut -f1)"
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: minecraft-modpack-${{ steps.config.outputs.new_version }}
        path: |
          *.jar
          *.json
          !pub.json5
          build-info.txt
          resourcepacks/
          mods/
          config/
        retention-days: 30
    
    - name: Create Release Draft
      id: create_release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.config.outputs.new_version }}
        name: ${{ steps.config.outputs.release_name }}
        body: |
          ## ${{ steps.config.outputs.release_name }}
          
          ### ğŸ“¦ ç‰ˆæœ¬ä¿¡æ¯
          - **ç‰ˆæœ¬æ ‡è¯†**: ${{ steps.config.outputs.new_version }}
          - **æäº¤æ¶ˆæ¯**: ${{ steps.commit.outputs.title }}
          - **æ„å»ºæ—¶é—´**: ${{ github.event.head_commit.timestamp }}
          - **æäº¤å“ˆå¸Œ**: ${{ github.sha }}
          
          ### ğŸ”„ æœ¬æ¬¡æ›´æ–°
          ${{ steps.commit.outputs.title }}
          
          ### ğŸ“‹ åŒ…å«å†…å®¹
          - Minecraft æ•´åˆåŒ…ä¸»æ–‡ä»¶ (.jar, .json)
          - é…ç½®æ–‡ä»¶ (options.txt, config/)
          - èµ„æºåŒ… (resourcepacks/)
          - æ¨¡ç»„æ–‡ä»¶ (mods/)
          - KubeJS è„šæœ¬ (kubejs/)
          - å…¶ä»–é…ç½®å’Œæ•°æ®æ–‡ä»¶
          
          ### ğŸš€ å®‰è£…è¯´æ˜
          1. ä¸‹è½½ä¸‹æ–¹çš„æ•´åˆåŒ…æ–‡ä»¶
          2. è§£å‹åˆ°æ‚¨çš„ Minecraft ç‰ˆæœ¬ç›®å½•
          3. ä½¿ç”¨å¯åŠ¨å™¨é€‰æ‹©å¯¹åº”ç‰ˆæœ¬å¯åŠ¨æ¸¸æˆ
          
          ### âš ï¸ æ³¨æ„äº‹é¡¹
          - è¯·ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„ Minecraft ç‰ˆæœ¬
          - å»ºè®®å¤‡ä»½æ‚¨çš„å­˜æ¡£æ•°æ®
          - é¦–æ¬¡å¯åŠ¨å¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´æ¥åŠ è½½æ¨¡ç»„
          - æœ¬æ„å»ºæœªæäº¤æ›´æ”¹åˆ°æºä»£ç ä»“åº“
          
          ---
          *æ­¤å‘è¡Œç‰ˆç”± GitHub Actions è‡ªåŠ¨æ„å»ºç”Ÿæˆ*
        files: ${{ steps.create_package.outputs.package_name }}
        draft: true
        prerelease: false
        token: ${{ secrets.GITHUB_TOKEN }}
